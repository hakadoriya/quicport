#!/usr/bin/env bash
set -Eeuo pipefail
# =============================================================================
# quicport-starter - systemd cgroup isolation architecture startup script
#
# This script is called from systemd and performs the following:
# 1. Starts the data-plane in a separate cgroup using systemd-run
# 2. Replaces the control-plane with exec
#
# This ensures:
# - control-plane and data-plane run in different cgroups
# - systemctl restart only restarts the control-plane, leaving data-plane running
# - graceful restart is possible
#
# Note: systemd-run --scope requires root privileges.
#       The systemd service must be run as root.
# =============================================================================

export PATH="${PATH:-}${PATH:+:}~/bin:~/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"

# LICENSE: https://github.com/hakadoriya/log.sh/blob/HEAD/LICENSE
# Common
_logshRFC3339() { date "+%Y-%m-%dT%H:%M:%S%z" | sed "s/\(..\)$/:\1/"; }
_logshCmd() { for a in "$@"; do if echo "${a:-}" | grep -Eq "[[:blank:]]"; then printf "'%s' " "${a:-}"; else printf "%s " "${a:-}"; fi; done | sed "s/ $//"; }
# JSON
_logshEscape() { printf %s "${1:-}" | sed "s/\"/\\\"/g; s/\r/\\\r/g; s/\t/\\\t/g; s/$/\\\n/g" | tr -d "[:cntrl:]" | sed "s/\\\n$/\n/"; }
# NOTE: shift 2 -> ${1+shift} && ${1+shift} ... avoid "shift: can't shift that many" error
_logshJSON() { _svr="${1:?}" && _msg="$(_logshEscape "${2:-}")" && unset _fld _val && ${1+shift} && ${1+shift} && for a in "$@"; do if [ "${_val:-}" ]; then _fld="${_fld:?}:\"$(_logshEscape "${a:-}")\"" && unset _val && continue; fi && _fld="${_fld:-}${_fld:+,}\"${a:?"json key is not set"}\"" && _val=1; done && test $(($# % 2)) = 1 && _fld="${_fld:?}:\"\"" || true && printf "{%s}\n" "\"${LOGSH_TIMESTAMP_KEY:-timestamp}\":\"$(_logshRFC3339)\",\"${LOGSH_LEVEL_KEY:-severity}\":\"${_svr:?}\",\"${LOGSH_CALLER_KEY:-caller}\":\"$0\",\"${LOGSH_MESSAGE_KEY:-message}\":\"${_msg:-}\"${_fld:+,}${_fld:-}"; }
LogshDefaultJSON() { test "  ${LOGSH_LEVEL:-0}" -gt 000 2>/dev/null || _logshJSON DEFAULT "$@" 1>&2; }
LogshDebugJSON() { test "    ${LOGSH_LEVEL:-0}" -gt 100 2>/dev/null || _logshJSON DEBUG "$@" 1>&2; }
LogshInfoJSON() { test "     ${LOGSH_LEVEL:-0}" -gt 200 2>/dev/null || _logshJSON INFO "$@" 1>&2; }
LogshNoticeJSON() { test "   ${LOGSH_LEVEL:-0}" -gt 300 2>/dev/null || _logshJSON NOTICE "$@" 1>&2; }
LogshWarnJSON() { test "     ${LOGSH_LEVEL:-0}" -gt 400 2>/dev/null || _logshJSON WARN "$@" 1>&2; }
LogshWarningJSON() { test "  ${LOGSH_LEVEL:-0}" -gt 400 2>/dev/null || _logshJSON WARNING "$@" 1>&2; }
LogshErrorJSON() { test "    ${LOGSH_LEVEL:-0}" -gt 500 2>/dev/null || _logshJSON ERROR "$@" 1>&2; }
LogshCriticalJSON() { test " ${LOGSH_LEVEL:-0}" -gt 600 2>/dev/null || _logshJSON CRITICAL "$@" 1>&2; }
LogshAlertJSON() { test "    ${LOGSH_LEVEL:-0}" -gt 700 2>/dev/null || _logshJSON ALERT "$@" 1>&2; }
LogshEmergencyJSON() { test "${LOGSH_LEVEL:-0}" -gt 800 2>/dev/null || _logshJSON EMERGENCY "$@" 1>&2; }
LogshExecJSON() { LogshInfoJSON "$ $(_logshCmd "$@")" && "$@"; }

# Configuration (overridable by environment variables)
QUICPORT_BIN="${QUICPORT_BIN:-quicport}"
QUICPORT_DP_ADDR="${QUICPORT_DP_ADDR:-0.0.0.0:39000}"
QUICPORT_CP_ADDR="${QUICPORT_CP_ADDR:-127.0.0.1:39000}"
# HTTP IPC URL (derived from CP_ADDR, can be overridden)
QUICPORT_CP_URL="${QUICPORT_CP_URL:-http://${QUICPORT_CP_ADDR}}"
QUICPORT_LOG_DIR="${QUICPORT_LOG_DIR:-/var/log/quicport}"

PROGRAM_NAME="quicport-starter"
# timestamp for log file name
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Create a log directory
# shellcheck disable=SC2174
mkdir -m 755 -p "${QUICPORT_LOG_DIR}"

# Build authentication arguments
QUICPORT_AUTH_ARGS=()

if [[ -n "${QUICPORT_PSK:-}" ]]; then
  QUICPORT_AUTH_ARGS+=("--psk" "${QUICPORT_PSK}")
fi

if [[ -n "${QUICPORT_PRIVKEY:-}" ]]; then
  QUICPORT_AUTH_ARGS+=("--privkey" "${QUICPORT_PRIVKEY}")
fi

if [[ -n "${QUICPORT_PRIVKEY_FILE:-}" ]]; then
  QUICPORT_AUTH_ARGS+=("--privkey-file" "${QUICPORT_PRIVKEY_FILE}")
fi

if [[ -n "${QUICPORT_CLIENT_PUBKEYS:-}" ]]; then
  QUICPORT_AUTH_ARGS+=("--client-pubkeys" "${QUICPORT_CLIENT_PUBKEYS}")
fi

if [[ -n "${QUICPORT_CLIENT_PUBKEYS_FILE:-}" ]]; then
  QUICPORT_AUTH_ARGS+=("--client-pubkeys-file" "${QUICPORT_CLIENT_PUBKEYS_FILE}")
fi

LogshInfoJSON "[${PROGRAM_NAME}] Starting data-plane in separate cgroup..."
LogshInfoJSON "[${PROGRAM_NAME}] QUICPORT_BIN=${QUICPORT_BIN}"
LogshInfoJSON "[${PROGRAM_NAME}] QUICPORT_DP_ADDR=${QUICPORT_DP_ADDR}"
LogshInfoJSON "[${PROGRAM_NAME}] QUICPORT_CP_URL=${QUICPORT_CP_URL}"

## data-plane is started in a separate cgroup by systemd-run
## the following options are required to separate the cgroup
##   --slice: specify the slice to place the unit
##   --unit: specify the unit name
#LogshExecJSON systemd-run \
#  --slice=user.slice \
#  --unit="quicport-data-plane-${TIMESTAMP}" \
#  --property=StandardOutput=append:/var/log/quicport/data-plane.log \
#  --property=StandardError=inherit \
#  --setenv=RUST_LOG=quicport=debug,quinn=debug \
#  --description="quicport data-plane (${TIMESTAMP})" \
#  "${QUICPORT_BIN}" \
#  --log-format json \
#  data-plane \
#  --listen "${QUICPORT_DP_ADDR}" \
#  --control-plane-url "${QUICPORT_CP_URL}" \
#  &
#
## wait for data-plane to start
#while ! pgrep -f "[q]uicport.* data-plane" >/dev/null; do
#  sleep 0.5
#done

LogshInfoJSON "[${PROGRAM_NAME}] Starting control-plane..."

# replace the control-plane with exec
# --no-auto-dataplane: data-plane is already started above via systemd-run
LogshExecJSON exec "${QUICPORT_BIN}" \
  --log-format json \
  control-plane \
  --control-plane-addr "${QUICPORT_CP_ADDR}" \
  --data-plane-addr "${QUICPORT_DP_ADDR}" \
  --no-auto-dataplane \
  "${QUICPORT_AUTH_ARGS[@]}"
